import{u as _e,h as d,j as ye,x as u,c as be,A as xe,B as V,k as ke,r as A,s as h,i as M,C as Ve,E as Ce,n as H,F as Pe,t as K,v as J,G as W,H as Se}from"./vendor-quasar-DQshVSCQ.js";import{r as c,f as X,w as Ue,e as $e,E as R,F as C,C as t,P as r,u as Be,O as he,B as o,L as Q,M as D,_ as Y,G as j,H as Z,$ as Re,A as Qe,j as ee,U as T}from"./vendor-auwb9AcH.js";const De={class:"tw-space-y-3"},Te={class:"tw-flex tw-flex-col md:tw-flex-row tw-gap-3 tw-mb-4"},Ee={class:"tw-flex tw-gap-2"},Ae={class:"tw-flex tw-gap-2 tw-w-full md:tw-w-[360px] lg:tw-w-[420px] md:tw-ml-auto md:tw-justify-end"},Me={class:"tw-text-xs tw-text-slate-700"},je={class:"text-h6"},Ie={class:"tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-3"},Ne={class:"tw-grid tw-grid-cols-1 lg:tw-grid-cols-2 tw-gap-4"},Le={class:"tw-space-y-2"},Fe={class:"tw-flex tw-items-center tw-justify-between"},qe={class:"tw-space-y-2"},ze={class:"tw-space-y-4"},Oe={class:"tw-space-y-2"},Ge={class:"tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-2"},He={class:"tw-space-y-2"},Ke={class:"tw-grid tw-grid-cols-1 md:tw-grid-cols-[1fr_auto] tw-gap-2 tw-items-center"},Je={class:"tw-flex tw-flex-wrap tw-gap-2 tw-min-h-[28px]"},We=400,Ze={__name:"Index",props:{integration:{type:Object,default:()=>({callback_base_url:"",user_code:""})}},setup(ae){const I=ae,N=c([]),x=c(!1),f=c({page:1,rowsPerPage:10,rowsNumber:0,sortBy:"name",descending:!1}),P=c(""),S=c(!1),y=c(!1),E=c(!1),g=c(null),s=c({}),w=_e();let U=null;const te=[{label:"Postback GET",value:"postback_get"}],$=()=>({id:null,name:"",slug:"",active:!0,integration_type:"postback_get",conversion_param_mapping:{conversion_value:"",currency_code:""}}),n=c($()),p=c([{source:"",target:""}]),m=c([]),_=c(""),L=X(()=>!!n.value.id),le=[{name:"name",label:"Nome",field:"name",sortable:!0,align:"left"},{name:"slug",label:"Slug",field:"slug",sortable:!0,align:"left"},{name:"integration_type",label:"Tipo de integração",field:"integration_type_label",sortable:!0,align:"left"},{name:"mapping",label:"Mapeamento",field:"mapping_preview",sortable:!1,align:"left"},{name:"active",label:"Status",field:"active",sortable:!0,align:"left"},{name:"created_at",label:"Criado em",field:"created_at",sortable:!0,align:"left"},{name:"integration",label:"Integração",field:"integration",sortable:!1,align:"center"},{name:"actions",label:"Ações",field:"id",align:"right"}],F=X(()=>{const l=String(I.integration?.callback_base_url||"").replace(/\/$/,""),e=String(I.integration?.user_code||"").trim(),a=String(n.value.slug||"").trim();if(!l||!e||!a)return"";const i=`${l}/${encodeURIComponent(a)}/${encodeURIComponent(e)}`,v=p.value.map(B=>String(B.target||"").trim()).filter(Boolean),b=[String(n.value?.conversion_param_mapping?.conversion_value||"").trim(),String(n.value?.conversion_param_mapping?.currency_code||"").trim()].filter(Boolean),G=[...new Set([...v,...b,...m.value])];if(G.length===0)return i;const we=G.map(B=>`${encodeURIComponent(B)}={${B}}`).join("&");return`${i}?${we}`});function oe(l){return l?new Date(l).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"}):"-"}function k(l){x.value=!0;const{page:e,rowsPerPage:a,sortBy:i,descending:v}=l.pagination;return T.get(route("panel.affiliate-platforms.data"),{params:{page:e,per_page:a,sortBy:i,descending:v,search:P.value||void 0}}).then(b=>{N.value=b.data.data,f.value={...f.value,page:b.data.current_page,rowsPerPage:b.data.per_page,rowsNumber:b.data.total,sortBy:i,descending:v}}).finally(()=>{x.value=!1})}function q(l=!1){U&&(clearTimeout(U),U=null);const e=()=>{f.value.page=1,k({pagination:f.value})};l?e():U=setTimeout(e,We)}function ne(){n.value=$(),p.value=[{source:"",target:""}],m.value=[],_.value="",s.value={},y.value=!0}function re(l){n.value={id:l.id,name:l.name,slug:l.slug,active:l.active,integration_type:l.integration_type||"postback_get",conversion_param_mapping:{conversion_value:String(l.conversion_param_mapping?.conversion_value||""),currency_code:String(l.conversion_param_mapping?.currency_code||"")}};const e=Object.entries(l.tracking_param_mapping||{}).map(([i,v])=>({source:String(i||""),target:String(v||"")})),a=(l.postback_additional_params||[]).map(i=>String(i||"").trim()).filter(Boolean);p.value=e.length>0?e:[{source:"",target:""}],m.value=[...new Set(a)],_.value="",s.value={},y.value=!0}function ie(){y.value=!1,n.value=$(),p.value=[{source:"",target:""}],m.value=[],_.value="",s.value={}}function se(){p.value.push({source:"",target:""})}function ue(l){if(p.value.length===1){p.value[0]={source:"",target:""};return}p.value.splice(l,1)}function z(){const l=String(_.value||"").trim();l&&(m.value.includes(l)||m.value.push(l),_.value="")}function de(l){m.value=m.value.filter(e=>e!==l)}function ce(){const l={};for(const e of p.value){const a=String(e.source||"").trim(),i=String(e.target||"").trim();!a||!i||(l[a]=i)}return l}function pe(){const l=m.value.map(e=>String(e||"").trim()).filter(Boolean);return[...new Set(l)]}function me(){const l=String(n.value?.conversion_param_mapping?.conversion_value||"").trim(),e=String(n.value?.conversion_param_mapping?.currency_code||"").trim(),a={};return l&&(a.conversion_value=l),e&&(a.currency_code=e),a}async function O(l,e){const a=String(l||"").trim();if(!a){w.notify({type:"warning",message:`${e} vazio.`});return}try{await Se(a),w.notify({type:"positive",message:`${e} copiado.`})}catch{w.notify({type:"negative",message:`Falha ao copiar ${e.toLowerCase()}.`})}}async function ve(){if(S.value)return;S.value=!0,s.value={};const l={...n.value,tracking_param_mapping:ce(),conversion_param_mapping:me(),postback_additional_params:pe()},e=n.value.id?T.put(route("panel.affiliate-platforms.update",n.value.id),l):T.post(route("panel.affiliate-platforms.store"),l);try{await e,y.value=!1,n.value=$(),p.value=[{source:"",target:""}],m.value=[],_.value="",w.notify({type:"positive",message:"Dados salvos com sucesso!"}),await k({pagination:f.value})}catch(a){a.response?.status===422?(s.value=a.response.data.errors||{},a.response.data.message&&w.notify({type:"warning",message:a.response.data.message})):w.notify({type:"negative",message:"Não foi possível salvar o registro."})}finally{S.value=!1}}async function ge(l){if(!l)return;const e=typeof window<"u"?window.$confirm:null;let a=!0;if(e?a=await e({title:"Excluir plataforma",message:"Esta ação é permanente. Deseja realmente remover?",okLabel:"Remover",okColor:"negative"}):typeof window<"u"&&(a=window.confirm("Excluir esta plataforma?")),!!a){x.value=!0;try{await T.delete(route("panel.affiliate-platforms.destroy",l)),w.notify({type:"positive",message:"Plataforma removida."}),await k({pagination:f.value})}catch(i){w.notify({type:"warning",message:i?.response?.data?.message||"Falha ao remover a plataforma."})}finally{x.value=!1}}}function fe(l){g.value=l,E.value=!0}return Ue(P,()=>{q()}),$e(()=>{k({pagination:f.value})}),(l,e)=>(C(),R(j,null,[t(Be(he),{title:"Plataformas de Afiliado"}),r("div",De,[t(A,{flat:"",bordered:"",class:"tw-rounded-2xl tw-p-4"},{default:o(()=>[r("div",Te,[r("div",Ee,[t(d,{color:"positive",unelevated:"",icon:"add",label:"Nova Plataforma",onClick:ne})]),t(ye),r("div",Ae,[t(u,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=a=>P.value=a),dense:"",outlined:"",clearable:"",placeholder:"Buscar por nome ou slug"},{append:o(()=>[t(be,{name:"search",class:"cursor-pointer",onClick:e[0]||(e[0]=a=>q(!0))})]),_:1},8,["modelValue"])])]),t(xe,{rows:N.value,columns:le,"row-key":"id",loading:x.value,pagination:f.value,"onUpdate:pagination":e[2]||(e[2]=a=>f.value=a),"binary-state-sort":!0,onRequest:k},{"body-cell-mapping":o(a=>[t(V,{props:a},{default:o(()=>[r("span",Me,D(a.value||"-"),1)]),_:2},1032,["props"])]),"body-cell-active":o(a=>[t(V,{props:a},{default:o(()=>[t(ke,{color:a.row.active?"positive":"grey-6",label:a.row.active?"Ativo":"Inativo"},null,8,["color","label"])]),_:2},1032,["props"])]),"body-cell-created_at":o(a=>[t(V,{props:a},{default:o(()=>[Q(D(oe(a.value)),1)]),_:2},1032,["props"])]),"body-cell-integration":o(a=>[t(V,{props:a,class:"tw-text-center"},{default:o(()=>[t(d,{flat:"",dense:"",size:"sm",icon:"link",color:"primary",onClick:i=>fe(a.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-actions":o(a=>[t(V,{props:a,class:"tw-text-right"},{default:o(()=>[t(d,{dense:"",flat:"",size:"sm",icon:"edit",class:"qtable-edit-btn",onClick:i=>re(a.row)},null,8,["onClick"]),t(d,{dense:"",flat:"",size:"sm",icon:"delete",class:"qtable-delete-btn",onClick:i=>ge(a.row.id)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","loading","pagination"])]),_:1})]),t(J,{modelValue:y.value,"onUpdate:modelValue":e[11]||(e[11]=a=>y.value=a),persistent:""},{default:o(()=>[t(A,{class:"tw-w-full tw-max-w-6xl",style:{width:"870px","max-width":"96vw"}},{default:o(()=>[t(h,null,{default:o(()=>[r("div",je,D(L.value?"Editar plataforma":"Nova plataforma"),1)]),_:1}),t(M),t(h,{class:"tw-space-y-3"},{default:o(()=>[r("div",Ie,[t(u,{modelValue:n.value.name,"onUpdate:modelValue":e[3]||(e[3]=a=>n.value.name=a),label:"Nome",dense:"",outlined:"",error:!!s.value.name,"error-message":s.value.name?.[0]},null,8,["modelValue","error","error-message"]),t(u,{modelValue:n.value.slug,"onUpdate:modelValue":e[4]||(e[4]=a=>n.value.slug=a),label:"Slug",dense:"",outlined:"",error:!!s.value.slug,"error-message":s.value.slug?.[0]},null,8,["modelValue","error","error-message"]),t(Ve,{modelValue:n.value.integration_type,"onUpdate:modelValue":e[5]||(e[5]=a=>n.value.integration_type=a),options:te,"option-label":"label","option-value":"value","emit-value":"","map-options":"",label:"Tipo de integração",dense:"",outlined:"",error:!!s.value.integration_type,"error-message":s.value.integration_type?.[0]},null,8,["modelValue","error","error-message"]),t(Ce,{modelValue:n.value.active,"onUpdate:modelValue":e[6]||(e[6]=a=>n.value.active=a),label:"Plataforma ativa"},null,8,["modelValue"])]),t(u,{"model-value":F.value,label:"URL de Postback (dinâmica)",dense:"",outlined:"",readonly:""},{append:o(()=>[t(d,{flat:"",dense:"",icon:"content_copy",onClick:e[7]||(e[7]=Y(a=>O(F.value,"URL de Postback"),["stop","prevent"]))})]),_:1},8,["model-value"]),r("div",Ne,[r("div",Le,[r("div",Fe,[e[15]||(e[15]=r("div",{class:"tw-text-sm tw-font-medium"},"Mapeamento de tracking (origem -> retorno)",-1)),t(d,{dense:"",unelevated:"",round:"",color:"positive","text-color":"white",icon:"add",onClick:se},{default:o(()=>[t(H,null,{default:o(()=>[...e[14]||(e[14]=[Q("Adicionar novo par de mapeamento",-1)])]),_:1})]),_:1})]),r("div",qe,[(C(!0),R(j,null,Z(p.value,(a,i)=>(C(),R("div",{key:`mapping-${i}`,class:"tw-grid tw-grid-cols-1 md:tw-grid-cols-[1fr_24px_1fr_auto] tw-gap-2 tw-items-center"},[t(u,{modelValue:a.source,"onUpdate:modelValue":v=>a.source=v,label:"Parâmetro origem",dense:"",outlined:"",placeholder:"ex: sub1"},null,8,["modelValue","onUpdate:modelValue"]),e[16]||(e[16]=r("div",{class:"tw-text-center tw-text-slate-500"},"->",-1)),t(u,{modelValue:a.target,"onUpdate:modelValue":v=>a.target=v,label:"Parâmetro retorno",dense:"",outlined:"",placeholder:"ex: subid1"},null,8,["modelValue","onUpdate:modelValue"]),t(d,{dense:"",flat:"",size:"sm",icon:"delete",class:"qtable-delete-btn",onClick:v=>ue(i)},null,8,["onClick"])]))),128))])]),r("div",ze,[r("div",Oe,[e[17]||(e[17]=r("div",{class:"tw-text-sm tw-font-medium"},"Mapeamento da conversão (postback -> conversão)",-1)),r("div",Ge,[t(u,{modelValue:n.value.conversion_param_mapping.conversion_value,"onUpdate:modelValue":e[8]||(e[8]=a=>n.value.conversion_param_mapping.conversion_value=a),label:"conversion_value",dense:"",outlined:"",placeholder:"ex: amount",error:!!s.value["conversion_param_mapping.conversion_value"],"error-message":s.value["conversion_param_mapping.conversion_value"]?.[0]},null,8,["modelValue","error","error-message"]),t(u,{modelValue:n.value.conversion_param_mapping.currency_code,"onUpdate:modelValue":e[9]||(e[9]=a=>n.value.conversion_param_mapping.currency_code=a),label:"currency_code",dense:"",outlined:"",placeholder:"ex: cy",error:!!s.value["conversion_param_mapping.currency_code"],"error-message":s.value["conversion_param_mapping.currency_code"]?.[0]},null,8,["modelValue","error","error-message"])]),e[18]||(e[18]=r("div",{class:"tw-text-xs tw-text-slate-500"}," Dica: estes campos são da tabela ads_conversions. Defina o parâmetro de retorno da plataforma para cada um (Dr Cash: conversion_value = amount, currency_code = cy). ",-1))])])]),r("div",He,[e[20]||(e[20]=r("div",{class:"tw-text-sm tw-font-medium"},"Parâmetros adicionais do postback",-1)),r("div",Ke,[t(u,{modelValue:_.value,"onUpdate:modelValue":e[10]||(e[10]=a=>_.value=a),label:"Parâmetro",dense:"",outlined:"",placeholder:"ex: orderid",onKeyup:Re(z,["enter"])},null,8,["modelValue"]),t(d,{dense:"",unelevated:"",round:"",color:"positive","text-color":"white",icon:"add",onClick:z},{default:o(()=>[t(H,null,{default:o(()=>[...e[19]||(e[19]=[Q("Adicionar parâmetro adicional",-1)])]),_:1})]),_:1})]),r("div",Je,[(C(!0),R(j,null,Z(m.value,a=>(C(),Qe(Pe,{key:`additional-${a}`,removable:"",dense:"",color:"blue-1","text-color":"primary",onRemove:i=>de(a)},{default:o(()=>[Q(D(a),1)]),_:2},1032,["onRemove"]))),128))]),e[21]||(e[21]=r("div",{class:"tw-text-xs tw-text-slate-500"}," Exemplo Dr Cash: orderid, product, amount, cy, status. ",-1))])]),_:1}),t(K,{align:"right",class:"tw-gap-2 tw-p-4"},{default:o(()=>[t(d,{flat:"",label:"Cancelar",onClick:ie}),t(d,{color:"primary",unelevated:"",loading:S.value,label:L.value?"Atualizar":"Cadastrar",onClick:ve},null,8,["loading","label"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(J,{modelValue:E.value,"onUpdate:modelValue":e[13]||(e[13]=a=>E.value=a)},{default:o(()=>[t(A,{style:{"min-width":"680px","max-width":"92vw"}},{default:o(()=>[t(h,{class:"tw-flex tw-items-center tw-justify-between"},{default:o(()=>[e[22]||(e[22]=r("div",{class:"tw-text-base tw-font-semibold"}," Integração de plataforma ",-1)),ee(t(d,{flat:"",round:"",dense:"",icon:"close"},null,512),[[W]])]),_:1}),t(M),t(h,{class:"tw-space-y-4"},{default:o(()=>[t(u,{"model-value":g.value?.callback_url??"",label:"URL de Postback",readonly:"",outlined:"",dense:""},{append:o(()=>[t(d,{flat:"",dense:"",icon:"content_copy",onClick:e[12]||(e[12]=Y(a=>O(g.value?.callback_url,"URL de Postback"),["stop","prevent"]))})]),_:1},8,["model-value"]),t(u,{"model-value":g.value?.integration_type_label??"",label:"Tipo de integração",readonly:"",outlined:"",dense:""},null,8,["model-value"]),t(u,{"model-value":g.value?.mapping_preview??"-",label:"Mapeamento de tracking",readonly:"",outlined:"",dense:""},null,8,["model-value"]),t(u,{"model-value":(g.value?.postback_additional_params||[]).join(", ")||"-",label:"Parâmetros adicionais",readonly:"",outlined:"",dense:""},null,8,["model-value"]),t(u,{"model-value":[g.value?.conversion_param_mapping?.conversion_value?`valor: ${g.value.conversion_param_mapping.conversion_value}`:null,g.value?.conversion_param_mapping?.currency_code?`moeda: ${g.value.conversion_param_mapping.currency_code}`:null].filter(Boolean).join(" | ")||"-",label:"Mapeamento de conversão",readonly:"",outlined:"",dense:""},null,8,["model-value"])]),_:1}),t(M),t(K,{align:"right"},{default:o(()=>[ee(t(d,{flat:"",label:"Fechar"},null,512),[[W]])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};export{Ze as default};
