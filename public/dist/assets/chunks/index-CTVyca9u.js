import{u as Le,h as d,s as _,x as A,c as Ge,A as J,B as b,F as Ae,r as D,G as $,i as B,t as De,v as Z,H as $e}from"./vendor-quasar-DSLrBDx5.js";import{f as Be,r as s,w as le,E as W,F as X,C as t,O as r,u as n,N as Ne,B as o,P as Ue,_ as je,L as m,K as oe,j as N,Z as U,M as ne,I as Qe,J as se,G as Te,Q as Y,S}from"./vendor-D6jaF0sv.js";import{q as i}from"./qtable-pt-CkdICETI.js";const qe={class:"tw-space-y-3"},Ie={class:"tw-flex tw-items-center tw-justify-between tw-flex-col sm:tw-flex-row tw-gap-3"},Ee={class:"tw-flex tw-gap-3 tw-flex-col md:tw-flex-row"},Fe={class:"tw-text-xs tw-text-slate-700"},Oe={class:"tw-text-xs tw-text-slate-700"},Me={class:"tw-flex tw-items-center tw-gap-3"},Ke={class:"tw-text-base tw-font-semibold"},He={class:"tw-inline-flex tw-items-center tw-rounded-full tw-bg-slate-100 tw-px-3 tw-py-1 tw-text-xs tw-font-medium tw-text-slate-600"},Je={class:"tw-flex tw-items-center tw-gap-2"},Ze={class:"tw-flex tw-items-center tw-gap-2"},We=["title"],Xe={class:"tw-flex tw-items-center tw-gap-3"},Ye={class:"tw-text-base tw-font-semibold"},ea={class:"tw-inline-flex tw-items-center tw-rounded-full tw-bg-slate-100 tw-px-3 tw-py-1 tw-text-xs tw-font-medium tw-text-slate-600"},aa={key:0,class:"tw-inline-flex tw-items-center tw-rounded-full tw-bg-amber-100 tw-px-3 tw-py-1 tw-text-xs tw-font-medium tw-text-amber-900"},ta={key:1,class:"tw-inline-flex tw-items-center tw-rounded-full tw-bg-slate-100 tw-px-3 tw-py-1 tw-text-xs tw-font-medium tw-text-slate-600"},la={class:"tw-flex tw-items-center tw-gap-2"},ra={__name:"Index",props:{conversionGoals:{type:Object,required:!0},logsRetentionDays:{type:Number,default:10},filters:{type:Object,default:()=>({})}},setup(re){const w=re,ie=Be(()=>w.conversionGoals?.data??[]),y=s(w.filters?.search??""),c=Le(),j=s(!1),f=s(null),z=s(!1),Q=s(!1),T=s(!1),q=s(""),P=s(null),R=s(0),V=s(null),I=s([]),E=s([]),L=s(!1),F=s(!1),x=s(!1),O=s(""),G=s([]),g=s({page:1,rowsPerPage:15,rowsNumber:0,sortBy:"created_at",descending:!0}),C=s(null),ue=[{name:"created_at",label:"Data",field:"created_at_formatted",align:"left",sortable:!0},{name:"message",label:"Mensagem",field:"message",align:"left",sortable:!1}],p=s({page:w.conversionGoals?.current_page??1,rowsPerPage:w.conversionGoals?.per_page??15,rowsNumber:w.conversionGoals?.total??0,sortBy:w.filters?.sort??"created_at",descending:(w.filters?.direction??"desc")==="desc"});le(()=>w.conversionGoals,a=>{a&&(p.value.page=a.current_page,p.value.rowsPerPage=a.per_page,p.value.rowsNumber=a.total)}),le(()=>w.filters,a=>{p.value.sortBy=a?.sort??"created_at",p.value.descending=(a?.direction??"desc")==="desc",(a?.search??"")!==y.value&&(y.value=a?.search??"")});const de=[{name:"id",label:"ID",field:"id",align:"left",sortable:!0},{name:"goal_code",label:"Codigo",field:"goal_code",align:"left",sortable:!0},{name:"active",label:"Status",field:"active",align:"center",sortable:!0},{name:"timezone",label:"Timezone",field:a=>a.timezone?.label??a.timezone?.identifier??"-",align:"left"},{name:"campaigns",label:"Campanhas",field:"campaigns",align:"left"},{name:"created_at",label:"Criado em",field:"created_at",align:"left",sortable:!0},{name:"integration",label:"Integracao",field:"integration",align:"center"},{name:"logs",label:"Logs",field:"logs",align:"center"},{name:"snapshot",label:"Snapshot CSV",field:"snapshot",align:"center"},{name:"actions",label:"Acoes",field:"actions",align:"right"}];function M(){const a={page:p.value.page,per_page:p.value.rowsPerPage,sort:p.value.sortBy,direction:p.value.descending?"desc":"asc",search:y.value||void 0};Y.get(route("panel.conversion-goals.index"),a,{preserveState:!0,preserveScroll:!0,replace:!0})}function ce({pagination:a}){Object.assign(p.value,a),M()}function K(){p.value.page=1,M()}function pe(){y.value!==""&&(y.value="",p.value.page=1,M())}function k(a){return a?.hashid??a?.id}function ge(a){Y.visit(route("panel.conversion-goals.edit",k(a)))}function we(a){const l=(a.campaigns??[]).map(u=>u?.name).filter(Boolean);if(!l.length)return"-";const e=l.join(", ");return e.length<=60?e:`${e.slice(0,60).trimEnd()}...`}function fe(a){c.dialog({title:"Confirmar exclusao",message:`Deseja realmente remover a meta "${a.goal_code}"?`,cancel:{label:"Cancelar",flat:!0},ok:{label:"Excluir",color:"negative",unelevated:!0},persistent:!0}).onOk(()=>{Y.delete(route("panel.conversion-goals.destroy",k(a)))})}function ve(a){f.value={id:k(a),url:a.integration_url,username:`googleads-${a.user_slug_id}`,password:a.googleads_password},j.value=!0}async function me(){!f.value?.id||z.value||c.dialog({title:"Gerar nova senha?",message:"Ao gerar uma nova senha, a conexão atual no Google Ads deixará de autenticar imediatamente até você atualizar a senha na configuração da fonte de dados.",cancel:{label:"Cancelar",flat:!0},ok:{label:"Gerar nova senha",color:"warning",unelevated:!0},persistent:!0}).onOk(async()=>{z.value=!0;try{const a=await S.patch(route("panel.conversion-goals.regenerate-password",f.value.id));f.value.password=a.data?.googleads_password??"",c.notify({type:"warning",message:"Nova senha gerada. Atualize a senha no Google Ads para restabelecer a conexão.",timeout:5500})}catch{c.notify({type:"negative",message:"Não foi possível gerar uma nova senha agora."})}finally{z.value=!1}})}async function H(a,l){const e=String(a??"");if(e===""){c.notify({type:"warning",message:`${l} vazio.`});return}try{await $e(e),c.notify({type:"positive",message:`${l} copiado.`})}catch{c.notify({type:"negative",message:`Falha ao copiar ${l.toLowerCase()}.`})}}function be(a,l){if(!Array.isArray(a)||a.length===0)return{columns:[],rows:[]};const e=a.map((h,v)=>({name:`c${v}`,label:String(h??""),field:`c${v}`,align:"left",sortable:!1})),u=Array.isArray(l)?l.map((h,v)=>{const te={__index:v+1};return e.forEach((Re,Ve)=>{te[Re.field]=Array.isArray(h)?h[Ve]??"":""}),te}):[];return{columns:e,rows:u}}async function ye(a){if(a){T.value=!0;try{const l=await S.get(route("panel.conversion-goals.snapshot",a));R.value=Number(l.data?.rows_count??0),V.value=l.data?.updated_at_formatted??null;const e=be(l.data?.header??[],l.data?.rows??[]);E.value=e.columns,I.value=e.rows}finally{T.value=!1}}}function he(a){const l=String(a??"");if(l==="")return null;const e=l.match(/filename\*=UTF-8''([^;]+)/i);return e?.[1]?decodeURIComponent(e[1].trim()):l.match(/filename=\"?([^\";]+)\"?/i)?.[1]?.trim()??null}async function _e(){if(!(!P.value||L.value)){L.value=!0;try{const a=await S.get(route("panel.conversion-goals.snapshot-csv",P.value),{responseType:"blob"});if(String(a.headers["content-type"]??"").includes("application/json")){c.notify({type:"warning",message:"Nenhum snapshot disponível para download."});return}const e=he(a.headers["content-disposition"])||`snapshot_${q.value||"conversion_goal"}.csv`,u=new Blob([a.data],{type:"text/csv;charset=utf-8;"}),h=window.URL.createObjectURL(u),v=document.createElement("a");v.href=h,v.download=e,document.body.appendChild(v),v.click(),document.body.removeChild(v),window.URL.revokeObjectURL(h)}catch{c.notify({type:"negative",message:"Não foi possível baixar o CSV do snapshot."})}finally{L.value=!1}}}async function xe(a){P.value=k(a),q.value=a.goal_code,R.value=0,V.value=null,E.value=[],I.value=[],Q.value=!0,await ye(P.value)}function ee(){return c.screen.lt.sm?"width: 96vw; max-width: 96vw; height: 92vh; max-height: 92vh;":c.screen.lt.md?"width: 92vw; max-width: 92vw; height: 90vh; max-height: 90vh;":"width: 70vw; max-width: 70vw; height: 88vh; max-height: 88vh;"}async function ae(a,l=null){if(!a)return;x.value=!0;const e=l??g.value;try{const u=await S.get(route("panel.conversion-goals.logs",a),{params:{page:e.page,per_page:e.rowsPerPage,sort:e.sortBy||"created_at",direction:e.descending?"desc":"asc"}});G.value=u.data.data??[],g.value={...g.value,page:u.data.current_page,rowsPerPage:u.data.per_page,rowsNumber:u.data.total,sortBy:e.sortBy||"created_at",descending:!!e.descending}}finally{x.value=!1}}async function Ce(a){C.value=k(a),O.value=a.goal_code,G.value=[],g.value={...g.value,page:1,sortBy:"created_at",descending:!0},F.value=!0,await ae(C.value,g.value)}async function ke({pagination:a}){g.value={...g.value,...a},await ae(C.value,g.value)}async function Se(){C.value&&c.dialog({title:"Excluir logs",message:`Deseja excluir todos os logs da meta ${O.value||""}?`,cancel:{label:"Cancelar",flat:!0},ok:{label:"Excluir logs",color:"negative",unelevated:!0},persistent:!0}).onOk(async()=>{x.value=!0;try{await S.delete(route("panel.conversion-goals.logs.destroy",C.value)),G.value=[],g.value={...g.value,page:1,rowsNumber:0},c.notify({type:"positive",message:"Logs removidos com sucesso."})}catch{c.notify({type:"negative",message:"Falha ao remover logs."})}finally{x.value=!1}})}function ze(a){return a==="success"?"tw-bg-emerald-500":a==="warning"?"tw-bg-amber-500":a==="error"?"tw-bg-rose-500":"tw-bg-slate-400"}function Pe(a){return a==="success"?"Sucesso":a==="warning"?"Atenção":a==="error"?"Erro":"Informação"}return(a,l)=>(X(),W(Te,null,[t(n(Ne),{title:"Metas de Conversao"}),r("div",qe,[r("div",Ie,[l[9]||(l[9]=r("h1",{class:"tw-text-lg tw-font-semibold"}," Metas de Conversao ",-1)),t(n(Ue),{href:a.route("panel.conversion-goals.create")},{default:o(()=>[t(d,{color:"positive",icon:"add",label:"Nova Meta",unelevated:""})]),_:1},8,["href"])]),t(D,{flat:"",bordered:""},{default:o(()=>[t(_,{class:"tw-space-y-3"},{default:o(()=>[r("div",Ee,[t(A,{modelValue:y.value,"onUpdate:modelValue":l[0]||(l[0]=e=>y.value=e),dense:"",outlined:"",clearable:"",placeholder:"Pesquisar por codigo",class:"md:tw-flex-1",onKeyup:je(K,["enter"]),onClear:pe},{append:o(()=>[t(Ge,{name:"search",class:"cursor-pointer",onClick:K})]),_:1},8,["modelValue"]),t(d,{outline:"",color:"primary",icon:"search",label:"Filtrar",class:"md:tw-w-auto",onClick:K})]),t(J,{flat:"",rows:ie.value,columns:de,"row-key":"id","binary-state-sort":"",pagination:p.value,"onUpdate:pagination":l[1]||(l[1]=e=>p.value=e),"rows-per-page-options":[10,15,25,50],"no-data-label":n(i).noData,"no-results-label":n(i).noResults,"loading-label":n(i).loading,"rows-per-page-label":n(i).recordsPerPage,"all-rows-label":n(i).allRows,"pagination-label":n(i).pagination,onRequest:ce},{"body-cell-active":o(e=>[t(b,{props:e,class:"tw-text-center"},{default:o(()=>[t(Ae,{dense:"",size:"sm",color:e.row.active?"positive":"negative","text-color":"white"},{default:o(()=>[oe(m(e.row.active?"Ativo":"Inativo"),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-created_at":o(e=>[t(b,{props:e},{default:o(()=>[oe(m(e.row.created_at?new Date(e.row.created_at).toLocaleString("pt-BR"):"-"),1)]),_:2},1032,["props"])]),"body-cell-campaigns":o(e=>[t(b,{props:e},{default:o(()=>[r("span",Fe,m(we(e.row)),1)]),_:2},1032,["props"])]),"body-cell-timezone":o(e=>[t(b,{props:e},{default:o(()=>[r("span",Oe,m(e.row.timezone?.label??e.row.timezone?.identifier??"-"),1)]),_:2},1032,["props"])]),"body-cell-actions":o(e=>[t(b,{props:e,class:"tw-text-right"},{default:o(()=>[t(d,{flat:"",dense:"",size:"sm",icon:"edit",class:"qtable-edit-btn",onClick:u=>ge(e.row)},null,8,["onClick"]),t(d,{flat:"",dense:"",size:"sm",icon:"delete",class:"qtable-delete-btn",onClick:u=>fe(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-integration":o(e=>[t(b,{props:e,class:"tw-text-center"},{default:o(()=>[t(d,{flat:"",dense:"",size:"sm",icon:"link",color:"primary",onClick:u=>ve(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-logs":o(e=>[t(b,{props:e,class:"tw-text-center"},{default:o(()=>[t(d,{flat:"",dense:"",size:"sm",icon:"history",label:"Logs",color:"secondary",onClick:u=>Ce(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-snapshot":o(e=>[t(b,{props:e,class:"tw-text-center"},{default:o(()=>[t(d,{flat:"",dense:"",size:"sm",icon:"table_view",label:"Snapshot",color:"indigo",onClick:u=>xe(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","pagination","no-data-label","no-results-label","loading-label","rows-per-page-label","all-rows-label","pagination-label"])]),_:1})]),_:1}),t(Z,{modelValue:j.value,"onUpdate:modelValue":l[5]||(l[5]=e=>j.value=e)},{default:o(()=>[t(D,{style:{"min-width":"620px","max-width":"90vw"}},{default:o(()=>[t(_,{class:"tw-flex tw-items-center tw-justify-between"},{default:o(()=>[l[10]||(l[10]=r("div",{class:"tw-text-base tw-font-semibold"}," Integração Google Ads ",-1)),N(t(d,{flat:"",round:"",dense:"",icon:"close"},null,512),[[$]])]),_:1}),t(B),t(_,{class:"tw-space-y-4"},{default:o(()=>[t(A,{"model-value":f.value?.url??"",label:"URL CSV",readonly:"",outlined:"",dense:""},{append:o(()=>[t(d,{flat:"",dense:"",icon:"content_copy",onClick:l[2]||(l[2]=U(e=>H(f.value?.url,"URL"),["stop","prevent"]))})]),_:1},8,["model-value"]),t(A,{"model-value":f.value?.username??"",label:"Usuário",readonly:"",outlined:"",dense:""},{append:o(()=>[t(d,{flat:"",dense:"",icon:"content_copy",onClick:l[3]||(l[3]=U(e=>H(f.value?.username,"Usuário"),["stop","prevent"]))})]),_:1},8,["model-value"]),t(A,{"model-value":f.value?.password??"",label:"Senha",readonly:"",outlined:"",dense:""},{append:o(()=>[t(d,{flat:"",dense:"",icon:"key",loading:z.value,onClick:U(me,["stop","prevent"])},null,8,["loading"]),t(d,{flat:"",dense:"",icon:"content_copy",onClick:l[4]||(l[4]=U(e=>H(f.value?.password,"Senha"),["stop","prevent"]))})]),_:1},8,["model-value"]),l[11]||(l[11]=r("div",{class:"tw-rounded-md tw-border tw-border-amber-200 tw-bg-amber-50 tw-p-3 tw-text-xs tw-text-amber-900"}," Se você gerar nova senha, atualize a credencial no Google Ads imediatamente. Enquanto a senha antiga estiver configurada lá, o Google não conseguirá autenticar e a importação falhará. ",-1))]),_:1}),t(B),t(De,{align:"right"},{default:o(()=>[N(t(d,{flat:"",label:"Fechar"},null,512),[[$]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Z,{modelValue:F.value,"onUpdate:modelValue":l[7]||(l[7]=e=>F.value=e),maximized:n(c).screen.lt.sm},{default:o(()=>[t(D,{style:ne(ee())},{default:o(()=>[t(_,{class:"tw-flex tw-items-center tw-justify-between"},{default:o(()=>[r("div",Me,[r("div",Ke," Logs da Meta "+m(O.value||"-"),1),r("span",He," Os logs são armazenados temporariamente e serão excluídos após "+m(w.logsRetentionDays)+" dias. ",1)]),r("div",Je,[t(d,{flat:"",dense:"",color:"negative",icon:"delete_sweep",label:"Excluir logs",disable:x.value||!C.value,onClick:Se},null,8,["disable"]),N(t(d,{flat:"",round:"",dense:"",icon:"close"},null,512),[[$]])])]),_:1}),t(B),t(_,{class:"tw-p-0",style:{height:"calc(100% - 72px)"}},{default:o(()=>[t(J,{flat:"",rows:G.value,columns:ue,"row-key":"id",loading:x.value,pagination:g.value,"onUpdate:pagination":l[6]||(l[6]=e=>g.value=e),"rows-per-page-options":[10,15,25,50],"no-data-label":n(i).noData,"no-results-label":n(i).noResults,"loading-label":n(i).loading,"rows-per-page-label":n(i).recordsPerPage,"all-rows-label":n(i).allRows,"pagination-label":n(i).pagination,"binary-state-sort":"",onRequest:ke},{"body-cell-message":o(e=>[t(b,{props:e},{default:o(()=>[r("div",Ze,[r("span",{class:Qe(["tw-inline-block tw-h-2.5 tw-w-2.5 tw-rounded-full",ze(e.row.status)]),title:Pe(e.row.status)},null,10,We),r("span",null,m(e.row.message),1)])]),_:2},1032,["props"])]),_:1},8,["rows","loading","pagination","no-data-label","no-results-label","loading-label","rows-per-page-label","all-rows-label","pagination-label"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue","maximized"]),t(Z,{modelValue:Q.value,"onUpdate:modelValue":l[8]||(l[8]=e=>Q.value=e),maximized:n(c).screen.lt.sm},{default:o(()=>[t(D,{style:ne(ee())},{default:o(()=>[t(_,{class:"tw-flex tw-items-center tw-justify-between"},{default:o(()=>[r("div",Xe,[r("div",Ye," Snapshot CSV da Meta "+m(q.value||"-"),1),r("span",ea," Última exportação: "+m(R.value)+" conversão(ões) ",1),R.value>100?(X(),W("span",aa," Visualizando apenas as 100 primeiras linhas do CSV da última exportação. ")):se("",!0),V.value?(X(),W("span",ta," Atualizado em "+m(V.value),1)):se("",!0)]),r("div",la,[t(d,{round:"",dense:"",unelevated:"",color:"grey-3","text-color":"positive",icon:"download",loading:L.value,onClick:_e},null,8,["loading"]),N(t(d,{flat:"",round:"",dense:"",icon:"close"},null,512),[[$]])])]),_:1}),t(B),t(_,{class:"tw-p-0",style:{height:"calc(100% - 72px)"}},{default:o(()=>[t(J,{flat:"",rows:I.value,columns:E.value,"row-key":"__index",loading:T.value,"rows-per-page-options":[10,15,25,50,100],"no-data-label":n(i).noData,"no-results-label":n(i).noResults,"loading-label":n(i).loading,"rows-per-page-label":n(i).recordsPerPage,"all-rows-label":n(i).allRows,"pagination-label":n(i).pagination},null,8,["rows","columns","loading","no-data-label","no-results-label","loading-label","rows-per-page-label","all-rows-label","pagination-label"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue","maximized"])])],64))}};export{ra as default};
